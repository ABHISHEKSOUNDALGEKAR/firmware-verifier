<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firmware Verifier</title>
<style>
  body{margin:0;background:#0d1117;color:#e6edf3;font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  .container{max-width:1200px;margin:auto;padding:20px}
  h1{margin:0 0 10px;font-size:24px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#161b22;border:1px solid #30363d;border-radius:10px;overflow:hidden;display:flex;flex-direction:column}
  .card h3{margin:0;padding:10px 14px;background:#21262d;font-size:13px;color:#8b949e;text-transform:uppercase}
  textarea,pre{flex:1;min-height:220px;border:0;padding:12px;background:#0d1117;color:#e6edf3;
    font-family:ui-monospace,Consolas,monospace;resize:vertical;white-space:pre-wrap;overflow:auto}
  .toolbar{margin:16px 0;display:flex;flex-wrap:wrap;gap:8px}
  button{padding:8px 14px;border:1px solid #30363d;border-radius:8px;cursor:pointer;background:#238636;color:white}
  button.secondary{background:#21262d;color:#e6edf3}
  select{padding:6px 8px;background:#161b22;color:#e6edf3;border:1px solid #30363d;border-radius:6px}
  .status{margin-top:12px;padding:8px 12px;border-radius:6px;font-size:14px}
  .ok{background:#1a472a;color:#7ee787}.err{background:#4c1a1a;color:#f85149}
</style>
</head>
<body>
<div class="container">
  <h1>Spec-Driven Firmware Verifier</h1>
  <div class="toolbar">
    <button id="btnCheck">Verify</button>
    <button id="btnFix">Auto-Fix → Apply</button>
    <button class="secondary" id="btnExport">Export Report</button>
    <select id="sampleSel">
      <option value="gpio">GPIO bad</option>
      <option value="uart">UART bad</option>
      <option value="pwm">PWM bad</option>
      <option value="mixed">Mixed errors</option>
      <option value="clean">Golden clean</option>
    </select>
    <button class="secondary" id="btnLoad">Load Sample</button>
    <button class="secondary" id="btnGolden">Golden Test</button>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Firmware Code</h3>
      <textarea id="fwCode"></textarea>
    </div>
    <div class="card">
      <h3>Hardware Spec JSON</h3>
      <textarea id="specBox"></textarea>
    </div>
  </div>

  <div class="grid" style="margin-top:16px">
    <div class="card"><h3>Findings</h3><pre id="outFind">(run verifier)</pre></div>
    <div class="card"><h3>Auto-Fixed Code (preview)</h3><pre id="outFix">(no fixes yet)</pre></div>
  </div>

  <div id="statusBar" class="status">Ready</div>
</div>

<script>
// samples
const examples={
  gpio:`void setup(){ digitalWrite(5,HIGH); } void loop(){}`,
  uart:`void setup(){ Serial.print("x"); } void loop(){}`,
  pwm:`void setup(){ analogWrite(9,300); } void loop(){}`,
  mixed:`void setup(){
  pinMode(2,INPUT);
  digitalWrite(2,HIGH);
  analogWrite(9,999);
}
void loop(){
  Serial.print("hi");
  digitalWrite(13,HIGH);
}`,
  clean:`void setup(){
  pinMode(2,INPUT);
  pinMode(5,OUTPUT);
  pinMode(9,OUTPUT);
  pinMode(13,OUTPUT);
  Serial.begin(9600);
  digitalWrite(5,HIGH);
  analogWrite(9,128);
}
void loop(){
  Serial.print("ok");
  digitalWrite(13,HIGH);
  digitalWrite(13,LOW);
}`
};

// default spec
const rules={
  pins:{ "2":{mode:"INPUT",must_init:true},"5":{mode:"OUTPUT",must_init:true},
         "9":{mode:"OUTPUT",must_init:true},"13":{mode:"OUTPUT",must_init:true}},
  uart:{must_begin:true,allowed_baud:[9600,115200]},
  pwm:{range:[0,255],require_output_mode:true}
};

// checker
function runCheck(code,spec){
  const lines=code.split("\n"), notes=[], inited=new Set(); let uart=false;
  lines.forEach((l,i)=>{
    if(/pinMode\(\s*(\d+),\s*OUTPUT/.test(l)) inited.add(RegExp.$1);
    if(/Serial\.begin/.test(l)) uart=true;
    if(/digitalWrite\(\s*(\d+)/.test(l)){
      const p=RegExp.$1, ps=spec.pins[p];
      if(ps?.must_init && !inited.has(p)){
        if(ps.mode==="OUTPUT") notes.push({k:"gpio_init",line:i+1,msg:`digitalWrite(${p}) before pinMode(${p},OUTPUT)`});
        else notes.push({k:"pin_conflict",line:i+1,msg:`digitalWrite(${p}) but spec says ${ps.mode}`});
      }
    }
    if(/analogWrite\(\s*(\d+),\s*(\d+)/.test(l)){
      const p=RegExp.$1,val=parseInt(RegExp.$2); const rng=spec.pwm.range;
      if(val<rng[0]||val>rng[1]) notes.push({k:"pwm_range",line:i+1,msg:`analogWrite(${p},${val}) outside ${rng}`});
      if(spec.pwm.require_output_mode && !inited.has(p)) notes.push({k:"pwm_mode",line:i+1,msg:`analogWrite(${p},${val}) needs pinMode(${p},OUTPUT)`});
    }
    if(/Serial\.(print|println|write)/.test(l)&&spec.uart.must_begin&&!uart){
      notes.push({k:"uart_begin",line:i+1,msg:`Serial used before Serial.begin`});
    }
  });
  return notes;
}

// fix
function autoFix(code,spec,viol){
  let lines=code.split("\n"), insert=[];
  if(viol.some(v=>v.k==="uart_begin")) insert.push(`  Serial.begin(${spec.uart.allowed_baud[0]});`);
  const pins=new Set();
  viol.forEach(v=>{
    const m=v.msg.match(/\((\d+)/); if(!m) return; const p=m[1]; const ps=spec.pins[p];
    if(v.k!=="pin_conflict"&&ps?.mode==="OUTPUT") pins.add(p);
  });
  [...pins].forEach(p=>insert.push(`  pinMode(${p},OUTPUT);`));
  const rng=spec.pwm.range;
  lines=lines.map(l=>{
    if(/analogWrite\(\s*(\d+),\s*(\d+)/.test(l)){
      const val=parseInt(RegExp.$2); if(val<rng[0]||val>rng[1]){
        return l.replace(val,Math.min(Math.max(val,rng[0]),rng[1]));
      }
    }
    return l;
  });
  const idx=lines.findIndex(l=>/void\s+setup\s*\(\)\s*\{/.test(l));
  if(idx>=0&&insert.length) lines.splice(idx+1,0,...insert);
  return lines.join("\n");
}

// wires
const fw=document.getElementById('fwCode'),
      specBox=document.getElementById('specBox'),
      out=document.getElementById('outFind'),
      fixed=document.getElementById('outFix'),
      statusBar=document.getElementById('statusBar');

document.getElementById('btnLoad').onclick=()=>{fw.value=examples[document.getElementById('sampleSel').value];specBox.value=JSON.stringify(rules,null,2)};
document.getElementById('btnCheck').onclick=()=>{
  let spec; try{spec=JSON.parse(specBox.value)}catch(e){out.textContent="❌ bad JSON";statusBar.textContent="Spec JSON invalid";statusBar.className="status err";return}
  const v=runCheck(fw.value,spec);
  out.textContent=v.length?v.map((x,i)=>`#${i+1} ❌ [${x.k}] line ${x.line}: ${x.msg}`).join("\n"):"✅ No violations";
  fixed.textContent="(no fixes yet)";
  statusBar.textContent=v.length?`${v.length} issues found`:"Clean";statusBar.className=v.length?"status err":"status ok";
};
document.getElementById('btnFix').onclick=()=>{
  let spec; try{spec=JSON.parse(specBox.value)}catch(e){out.textContent="❌ bad JSON";return}
  const v=runCheck(fw.value,spec); const fix=autoFix(fw.value,spec,v);
  fixed.textContent=fix; fw.value=fix; statusBar.textContent="Fixes applied";statusBar.className="status ok";
};
document.getElementById('btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify({code:fw.value,spec:specBox.value},null,2)],{type:"application/json"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="report.json";a.click();
};

// Golden test
document.getElementById('btnGolden').onclick=()=>{
  fw.value=examples.clean;
  specBox.value=JSON.stringify(rules,null,2);
  const v=runCheck(fw.value,rules);
  out.textContent=v.length?"❌ Unexpected issues":"✅ No violations";
  fixed.textContent="(no fixes yet)";
  statusBar.textContent="Golden test run";statusBar.className=v.length?"status err":"status ok";
};

// init defaults
fw.value=examples.mixed; specBox.value=JSON.stringify(rules,null,2);
</script>
</body>
</html>
